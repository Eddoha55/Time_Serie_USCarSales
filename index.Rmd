---
title: "Machine Learning on US presidential election of 2016"
author: '[Leonard Henriquez](https://github.com/leonard-henriquez/), Adrien Lequiller & Eddy Ohayon'
date: "`r Sys.Date()`"
output: pdf_document
always_allow_html: yes
---

The full repository (including dataset) is available [here](https://github.com/leonard-henriquez/car_sales)

```{r message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, warning=FALSE)
library(plotly)
library(zoo)
seed <- 31
```

```{r}
mydata=read.csv("input/TOTALNSA.csv",header=T,dec=".")

TOTALNSA.ts=ts(mydata$TOTALNSA,frequency=12,c(1976,1))
df <- data.frame(date=as.Date(as.yearmon(time(TOTALNSA.ts))), values = melt(TOTALNSA.ts)$value)

title  <- "Total Vehicle Sales in thousands of units over months"
x.axis <- "Months"
y.axis <- "Total Vehicle Sales (in thousands of units)"

plot.serie = function(df) {
  plot_ly(df, x=~date) %>%
  add_trace(y = ~values, mode = 'lines') %>%
  layout(title = title,
       xaxis = list(title = x.axis),
       yaxis = list(title = y.axis))
}

plot.serie(df)

#there is clear growing trend but with period of crisis
```
```{r}
monthplot.serie <- function(df) {
  df$month <- factor(month(df$date), levels=1:12, labels=month.abb, ordered=TRUE)
  df$year  <- year(df$date)
  
  hline.data <- ddply(df, .(month), summarize, avgvalue=mean(values))
  head(hline.data)
  
  plot <- ggplot() + 
    geom_line(aes(x=year, y=values, group=month), data=df) +
    geom_hline(aes(yintercept=avgvalue), data=hline.data) +
    facet_grid(~month) +
    theme(
      axis.title.x=element_blank(),
      axis.text.x=element_blank(),
      axis.ticks.x=element_blank())
  ggplotly(plot)
}

monthplot.serie(df)

```

```{r}
#maybe we could start a new dataset from 2007-2008 for better predictions

monthplot(TOTALNSA.ts)
#saisonnalitÃ©

```

```{r}
y1= diff(TOTALNSA.ts,lag=12)
plot(y1)
#mauvais 
```

```{r}
y2= diff(log(TOTALNSA.ts),lag=12)
plot(y2)
#mauvais 
```

```{r}
y3=diff(TOTALNSA.ts)
plot(y3)
#pas mal
```

```{r}
y4=diff(diff(TOTALNSA.ts,lag=12))
plot(y4)
#pas mal aussi
```

```{r}
acf(y3) 
pacf(y3)
```

```{r}
acf(y4)
pacf(y4)
```

```{r}
model1<- arima(TOTALNSA.ts, order = c(0,1,1),seasonal=c(0,1,0))
model1
acf(model1$residuals) 
Box.test(model1$residuals, lag = 15, type="Ljung-Box")
#fonctionne pas
```

```{r}
model2<- arima(TOTALNSA.ts, order = c(2,1,2),seasonal=c(2,1,2))
model2
acf(model2$residuals) 
Box.test(model2$residuals, lag = 15, type="Ljung-Box")

#semble etre le plus court et le meilleur apres plusieurs tests
```

```{r}
myforecast<-predict(model2,n.ahead=5)
point.forecast<-myforecast$pred
SE<-myforecast$se
lower<-point.forecast-qnorm(0.975)*SE
upper<-point.forecast+qnorm(0.975)*SE
plot(TOTALNSA.ts,xlim=c(2000,2019))
# we adjust the scale of the axes to get a nicer plot
lines(point.forecast,col="red")
lines(lower,col="blue")
lines(upper,col="blue")
```

